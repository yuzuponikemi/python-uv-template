name: Auto-fix with Claude

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: ["claude/**"]

jobs:
  auto-fix:
    # Only run if CI workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Download test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs
          path: ./test-logs
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare error context
        id: prepare-context
        run: |
          # Combine all error logs into a single context file
          echo "## CI Test Failure Report" > error-context.md
          echo "" >> error-context.md
          echo "**Branch:** ${{ github.event.workflow_run.head_branch }}" >> error-context.md
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> error-context.md
          echo "**Workflow Run:** ${{ github.event.workflow_run.html_url }}" >> error-context.md
          echo "" >> error-context.md

          if [ -f ./test-logs/pytest.log ]; then
            echo "### Pytest Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/pytest.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          if [ -f ./test-logs/ruff-check.log ]; then
            echo "### Ruff Linter Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/ruff-check.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          if [ -f ./test-logs/ruff-format.log ]; then
            echo "### Ruff Format Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/ruff-format.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          if [ -f ./test-logs/mypy.log ]; then
            echo "### Mypy Type Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/mypy.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          echo "Error context prepared."

      - name: Create issue for auto-fix
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorContext = fs.readFileSync('error-context.md', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto-fix] CI Failed on ${context.payload.workflow_run.head_branch}`,
              body: `${errorContext}

            ---

            @claude CIが失敗しました。以下の手順で修正してください：

            1. エラーログを詳しく分析してください
            2. 根本的な原因を特定してください
            3. 修正を実装してください（テスト駆動開発の原則に従って）
            4. すべてのテストが通ることを確認してください
            5. 修正を \`${context.payload.workflow_run.head_branch}\` ブランチにコミットしてください

            修正後、このIssueをクローズしてください。`,
              labels: ['auto-fix', 'claude']
            });

            return issue.data.number;

      - name: Wait for Claude to process
        run: |
          echo "Issue created for Claude to auto-fix the errors."
          echo "Claude will analyze the errors and push fixes to the branch."
          echo "Issue number: ${{ steps.create-issue.outputs.result }}"
