name: Auto-fix with Claude

# This workflow is triggered by CI workflow failures on claude/** branches
# For local testing with act:
#   act workflow_dispatch             # Test manual trigger
#   act -j auto-fix                   # Run specific job
# Note: workflow_run events are not supported by act, so use workflow_dispatch for testing
# Note: Issue creation and artifact downloads will be skipped in act (local) mode

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: ["claude/**"]
  workflow_dispatch:  # Allow manual trigger for act local testing
    inputs:
      simulate_failure:
        description: 'Simulate CI failure for testing'
        required: false
        default: 'false'

jobs:
  auto-fix:
    # Only run if CI workflow failed or manual trigger with simulate_failure
    if: ${{ github.event.workflow_run.conclusion == 'failure' || (github.event_name == 'workflow_dispatch' && github.event.inputs.simulate_failure == 'true') || env.ACT }}
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0

      - name: Download test logs
        if: ${{ !env.ACT && github.event_name == 'workflow_run' }}
        uses: actions/download-artifact@v4
        with:
          name: test-logs
          path: ./test-logs
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare error context
        id: prepare-context
        run: |
          # Combine all error logs into a single context file
          echo "## CI Test Failure Report" > error-context.md
          echo "" >> error-context.md
          echo "**Branch:** ${{ github.event.workflow_run.head_branch }}" >> error-context.md
          echo "**Commit:** ${{ github.event.workflow_run.head_sha }}" >> error-context.md
          echo "**Workflow Run:** ${{ github.event.workflow_run.html_url }}" >> error-context.md
          echo "" >> error-context.md

          if [ -f ./test-logs/pytest.log ]; then
            echo "### Pytest Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/pytest.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          if [ -f ./test-logs/ruff-check.log ]; then
            echo "### Ruff Linter Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/ruff-check.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          if [ -f ./test-logs/ruff-format.log ]; then
            echo "### Ruff Format Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/ruff-format.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          if [ -f ./test-logs/mypy.log ]; then
            echo "### Mypy Type Errors" >> error-context.md
            echo '```' >> error-context.md
            cat ./test-logs/mypy.log >> error-context.md
            echo '```' >> error-context.md
            echo "" >> error-context.md
          fi

          echo "Error context prepared."

      - name: Create issue for auto-fix
        if: ${{ !env.ACT }}
        id: create-issue
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const errorContext = fs.readFileSync('error-context.md', 'utf8');

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Auto-fix] CI Failed on ${context.payload.workflow_run.head_branch}`,
              body: `${errorContext}

            ---

            @claude CIが失敗しました。以下の手順で修正してください：

            1. エラーログを詳しく分析してください
            2. 根本的な原因を特定してください
            3. 修正を実装してください（テスト駆動開発の原則に従って）
            4. すべてのテストが通ることを確認してください
            5. 修正を \`${context.payload.workflow_run.head_branch}\` ブランチにコミットしてください

            修正後、このIssueをクローズしてください。`,
              labels: ['auto-fix', 'claude']
            });

            return issue.data.number;

      - name: Display results
        run: |
          if [ -z "$ACT" ]; then
            echo "Issue created for Claude to auto-fix the errors."
            echo "Claude will analyze the errors and push fixes to the branch."
            echo "Issue number: ${{ steps.create-issue.outputs.result }}"
          else
            echo "Running in act (local) mode - GitHub API calls skipped"
            echo "Error context prepared and would be sent to Claude in production"
            if [ -f error-context.md ]; then
              echo "=== Error Context ==="
              cat error-context.md
            fi
          fi
