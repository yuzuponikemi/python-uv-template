name: Auto-fix with Gemini

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: ["claude/**", "ai/**", "gemini/**"]

jobs:
  auto-fix-gemini:
    # Only run if CI workflow failed
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_branch }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Download test logs
        uses: actions/download-artifact@v4
        with:
          name: test-logs
          path: ./test-logs
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install dependencies for auto-fix script
        run: |
          pip install google-generativeai pyyaml

      - name: Run Gemini auto-fix analysis
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          BRANCH_NAME: ${{ github.event.workflow_run.head_branch }}
        run: |
          python scripts/gemini_autofix.py

      - name: Check for existing auto-fix issue
        id: check-existing
        uses: actions/github-script@v7
        with:
          script: |
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'auto-fix',
            });

            const commitSha = context.payload.workflow_run.head_sha;
            const branch = context.payload.workflow_run.head_branch;

            // Check if there's already an open issue for this branch or commit
            const existingIssue = issues.find(issue =>
              issue.title.includes(branch) || issue.body.includes(commitSha)
            );

            if (existingIssue) {
              console.log(`Found existing issue #${existingIssue.number}`);
              return existingIssue.number;
            }
            return null;

      - name: Create issue for manual review
        if: steps.check-existing.outputs.result == 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let errorContext = '';

            // Read error logs
            const logFiles = ['pytest.log', 'ruff-check.log', 'ruff-format.log', 'mypy.log'];
            for (const logFile of logFiles) {
              const logPath = `./test-logs/${logFile}`;
              if (fs.existsSync(logPath)) {
                errorContext += `\n### ${logFile}\n\`\`\`\n`;
                errorContext += fs.readFileSync(logPath, 'utf8');
                errorContext += '\n\`\`\`\n';
              }
            }

            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[Gemini Auto-fix] CI Failed on ${context.payload.workflow_run.head_branch}`,
              body: `## CI Failure Report

**Branch:** ${context.payload.workflow_run.head_branch}
**Commit:** ${context.payload.workflow_run.head_sha}
**Workflow Run:** ${context.payload.workflow_run.html_url}

${errorContext}

---

Gemini analysis has been run. Please review the auto-fix suggestions and apply as needed.

To manually trigger a fix, comment with:
\`\`\`
@ai Please fix the CI failures above
\`\`\`
              `,
              labels: ['auto-fix', 'gemini', 'ci-failure']
            });

            console.log(\`Issue created: #\${issue.data.number}\`);

      - name: Comment on existing issue
        if: steps.check-existing.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.check-existing.outputs.result }};
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issueNumber,
              body: `⚠️ CI still failing for commit ${context.payload.workflow_run.head_sha}\n\nWorkflow run: ${context.payload.workflow_run.html_url}\n\nPlease fix the issues in the code to stop this workflow from re-running.`
            });
