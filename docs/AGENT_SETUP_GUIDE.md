# エージェント別セットアップガイド

このドキュメントでは、各コーディングエージェントの具体的な実装方法と設定手順を説明します。

## 目次

1. [Claude Code](#1-claude-code)
2. [Google Gemini](#2-google-gemini)
3. [GitHub Copilot CLI](#3-github-copilot-cli)
4. [SWE-agent](#4-swe-agent)
5. [カスタムエージェントの追加](#5-カスタムエージェントの追加)

---

## 1. Claude Code

### 概要

- **提供元**: Anthropic
- **特徴**: TDD、研究ソフトウェア開発、GitHub統合
- **推奨用途**: 研究プロジェクト、自動CI修正

### セットアップ手順

#### 1.1 API Keyの取得

1. [Anthropic Console](https://console.anthropic.com/) にアクセス
2. アカウントを作成/ログイン
3. "API Keys" セクションでAPIキーを生成

#### 1.2 プロジェクト設定

**ローカル開発:**

```bash
# .envファイルを作成
cp .env.example .env

# .envファイルを編集してAPIキーを設定
ANTHROPIC_API_KEY=sk-ant-your-api-key-here
```

**GitHub Actions:**

1. リポジトリの Settings > Secrets and variables > Actions
2. "New repository secret" をクリック
3. Name: `ANTHROPIC_API_KEY`
4. Secret: あなたのAPIキー

#### 1.3 エージェント設定

`.agent-config.yml`:

```yaml
agent:
  type: claude_code
  model: claude-sonnet-4-5-20250929
  max_tokens: 4096
  temperature: 0.7

claude_code:
  tdd_mode: true
  research_software_mode: true
```

#### 1.4 使用方法

**GitHub Issue/PR:**

```markdown
新しい統計解析関数を実装してください @claude

要件:
- テスト駆動開発で実装
- NumPyとSciPyを使用
- 型ヒントとdocstringを含める
```

**Python API:**

```python
from src.agent_abstraction import AgentFactory, AgentType

agent = AgentFactory.create_agent(
    agent_type=AgentType.CLAUDE_CODE,
    api_key="sk-ant-...",
    model="claude-sonnet-4-5-20250929"
)

response = agent.process_task("新機能を実装してください")
print(response.message)
```

---

## 2. Google Gemini

### 概要

- **提供元**: Google
- **特徴**: 高速、長コンテキスト（2M tokens）、マルチモーダル
- **推奨用途**: 大規模コードベース、画像処理

### セットアップ手順

#### 2.1 API Keyの取得

1. [Google AI Studio](https://makersuite.google.com/app/apikey) にアクセス
2. Googleアカウントでログイン
3. "Create API Key" をクリック

#### 2.2 Python SDKのインストール

```bash
# requirements.inに追加
echo "google-generativeai>=0.3.0" >> requirements.in

# コンパイルとインストール
make compile
make install
```

#### 2.3 Gemini実装の完成

`src/agent_abstraction/gemini.py` を以下のように更新:

```python
"""Gemini CLI agent implementation."""

from typing import Any, Optional

try:
    import google.generativeai as genai
except ImportError:
    genai = None

from .base_agent import AgentConfig, AgentResponse, AgentType, BaseAgent


class GeminiAgent(BaseAgent):
    """Google Gemini agent implementation."""

    def __init__(self, config: AgentConfig) -> None:
        if genai is None:
            raise ImportError(
                "google-generativeai is required for Gemini. "
                "Install with: pip install google-generativeai"
            )

        if config.agent_type != AgentType.GEMINI:
            config.agent_type = AgentType.GEMINI
        super().__init__(config)

        # Configure Gemini
        genai.configure(api_key=self.config.api_key)
        self.model = genai.GenerativeModel(self.config.model)

    def _validate_config(self) -> None:
        if not self.config.api_key:
            raise ValueError("GOOGLE_API_KEY is required for Gemini")

        if not self.config.model:
            self.config.model = "gemini-2.0-flash-exp"

    def process_task(
        self, task: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        try:
            # Create prompt
            prompt = f"""You are a coding assistant following Test-Driven Development.

Task: {task}

Context: {context or {}}

Please provide a complete implementation with:
1. Tests first (TDD)
2. Type hints
3. Docstrings
4. Clean code
"""

            # Generate response
            response = self.model.generate_content(
                prompt,
                generation_config={
                    "max_output_tokens": self.config.max_tokens,
                    "temperature": self.config.temperature,
                }
            )

            return AgentResponse(
                success=True,
                message=response.text,
                changes=["Code generated by Gemini"],
                metadata={"model": self.config.model, "context": context or {}},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to process task",
                error=str(e),
            )

    def fix_ci_errors(
        self, error_logs: dict[str, str], branch: str
    ) -> AgentResponse:
        try:
            combined_errors = "\n\n".join(
                f"=== {error_type} ===\n{log}"
                for error_type, log in error_logs.items()
            )

            prompt = f"""Analyze and fix these CI errors:

{combined_errors}

Branch: {branch}

Provide:
1. Root cause analysis
2. Fix implementation
3. Prevention strategy
"""

            response = self.model.generate_content(prompt)

            return AgentResponse(
                success=True,
                message=response.text,
                changes=["CI fixes generated by Gemini"],
                metadata={"branch": branch, "error_types": list(error_logs.keys())},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to fix CI errors",
                error=str(e),
            )

    def review_code(
        self, diff: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        try:
            prompt = f"""Review this code change:

```diff
{diff}
```

Context: {context or {}}

Provide:
1. Code quality assessment
2. Potential bugs
3. Improvement suggestions
4. Security concerns
"""

            response = self.model.generate_content(prompt)

            return AgentResponse(
                success=True,
                message=response.text,
                changes=["Code review by Gemini"],
                metadata={"diff_size": len(diff), "context": context or {}},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to review code",
                error=str(e),
            )
```

#### 2.4 エージェント設定

`.agent-config.yml`:

```yaml
agent:
  type: gemini
  model: gemini-2.0-flash-exp
  max_tokens: 8192
  temperature: 0.7

gemini:
  multimodal: true
```

#### 2.5 使用方法

**環境変数設定:**

```bash
export GOOGLE_API_KEY=your-api-key-here
```

**Python API:**

```python
from src.agent_abstraction import AgentFactory, AgentType

agent = AgentFactory.create_agent(
    agent_type=AgentType.GEMINI,
    api_key="your-api-key",
    model="gemini-2.0-flash-exp"
)

response = agent.process_task("Implement a binary search tree")
print(response.message)
```

---

## 3. GitHub Copilot CLI

### 概要

- **提供元**: GitHub/OpenAI
- **特徴**: GitHub統合、コマンドライン最適化
- **推奨用途**: シェルコマンド生成、Git操作

### セットアップ手順

#### 3.1 GitHub Copilot CLIのインストール

```bash
# Node.jsが必要（v16以上）
npm install -g @githubnext/github-copilot-cli

# GitHub CLIで認証
gh auth login

# Copilot CLIの認証
github-copilot-cli auth
```

#### 3.2 Python SDKのインストール

```bash
# requirements.inに追加
echo "openai>=1.0.0" >> requirements.in

make compile
make install
```

#### 3.3 新しいエージェントタイプの追加

`src/agent_abstraction/base_agent.py` を更新:

```python
class AgentType(Enum):
    """Supported coding agent types."""

    CLAUDE_CODE = "claude_code"
    GEMINI = "gemini"
    CODEX = "codex"
    SWE_AGENT = "swe_agent"
    COPILOT = "copilot"  # 追加
```

#### 3.4 Copilot実装の作成

`src/agent_abstraction/copilot.py`:

```python
"""GitHub Copilot CLI agent implementation."""

import subprocess
from typing import Any, Optional

from openai import OpenAI

from .base_agent import AgentConfig, AgentResponse, AgentType, BaseAgent


class CopilotAgent(BaseAgent):
    """GitHub Copilot CLI agent implementation."""

    def __init__(self, config: AgentConfig) -> None:
        if config.agent_type != AgentType.COPILOT:
            config.agent_type = AgentType.COPILOT
        super().__init__(config)

        # Initialize OpenAI client (Copilot uses OpenAI backend)
        self.client = OpenAI(api_key=self.config.api_key)

    def _validate_config(self) -> None:
        if not self.config.api_key:
            raise ValueError("OPENAI_API_KEY is required for Copilot")

        if not self.config.model:
            self.config.model = "gpt-4-turbo"

    def process_task(
        self, task: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        try:
            # Use OpenAI API (Copilot backend)
            response = self.client.chat.completions.create(
                model=self.config.model,
                messages=[
                    {
                        "role": "system",
                        "content": "You are GitHub Copilot, a coding assistant.",
                    },
                    {"role": "user", "content": task},
                ],
                max_tokens=self.config.max_tokens,
                temperature=self.config.temperature,
            )

            return AgentResponse(
                success=True,
                message=response.choices[0].message.content,
                changes=["Code generated by Copilot"],
                metadata={"model": self.config.model, "context": context or {}},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to process task",
                error=str(e),
            )

    def fix_ci_errors(
        self, error_logs: dict[str, str], branch: str
    ) -> AgentResponse:
        try:
            combined_errors = "\n\n".join(
                f"=== {error_type} ===\n{log}"
                for error_type, log in error_logs.items()
            )

            prompt = f"""Analyze and fix these CI errors:

{combined_errors}

Branch: {branch}

Provide fixes following TDD principles.
"""

            response = self.client.chat.completions.create(
                model=self.config.model,
                messages=[
                    {"role": "system", "content": "You are a debugging expert."},
                    {"role": "user", "content": prompt},
                ],
                max_tokens=self.config.max_tokens,
            )

            return AgentResponse(
                success=True,
                message=response.choices[0].message.content,
                changes=["CI fixes generated by Copilot"],
                metadata={"branch": branch, "error_types": list(error_logs.keys())},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to fix CI errors",
                error=str(e),
            )

    def review_code(
        self, diff: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        try:
            prompt = f"""Review this code change:

```diff
{diff}
```

Provide detailed code review.
"""

            response = self.client.chat.completions.create(
                model=self.config.model,
                messages=[
                    {"role": "system", "content": "You are a code reviewer."},
                    {"role": "user", "content": prompt},
                ],
                max_tokens=self.config.max_tokens,
            )

            return AgentResponse(
                success=True,
                message=response.choices[0].message.content,
                changes=["Code review by Copilot"],
                metadata={"diff_size": len(diff), "context": context or {}},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to review code",
                error=str(e),
            )
```

#### 3.5 ファクトリーに登録

`src/agent_abstraction/factory.py`:

```python
from .copilot import CopilotAgent  # 追加

class AgentFactory:
    _agent_classes = {
        AgentType.CLAUDE_CODE: ClaudeCodeAgent,
        AgentType.GEMINI: GeminiAgent,
        AgentType.CODEX: CodexAgent,
        AgentType.SWE_AGENT: SWEAgent,
        AgentType.COPILOT: CopilotAgent,  # 追加
    }
```

#### 3.6 エージェント設定

`.agent-config.yml`:

```yaml
agent:
  type: copilot
  model: gpt-4-turbo
  max_tokens: 4096
  temperature: 0.7

copilot:
  cli_integration: true
```

---

## 4. SWE-agent

### 概要

- **提供元**: Princeton NLP (オープンソース)
- **特徴**: 自律的バグ修正、リポジトリナビゲーション
- **推奨用途**: 複雑なバグ修正、コードベース理解
- **GitHub**: https://github.com/princeton-nlp/SWE-agent

### セットアップ手順

#### 4.1 SWE-agentのインストール

```bash
# SWE-agentをクローン
git clone https://github.com/princeton-nlp/SWE-agent.git
cd SWE-agent

# 依存関係をインストール
pip install -e .

# Docker（推奨）
docker pull sweagent/swe-agent:latest
```

#### 4.2 API設定

SWE-agentは複数のLLMバックエンドをサポート:

**OpenAI:**
```bash
export OPENAI_API_KEY=your-key
```

**Anthropic:**
```bash
export ANTHROPIC_API_KEY=your-key
```

#### 4.3 SWE-agent実装の完成

`src/agent_abstraction/swe_agent.py` を更新:

```python
"""SWE-agent implementation."""

import json
import subprocess
from pathlib import Path
from typing import Any, Optional

from .base_agent import AgentConfig, AgentResponse, AgentType, BaseAgent


class SWEAgent(BaseAgent):
    """SWE-agent implementation for autonomous debugging."""

    def __init__(self, config: AgentConfig) -> None:
        if config.agent_type != AgentType.SWE_AGENT:
            config.agent_type = AgentType.SWE_AGENT
        super().__init__(config)

        # SWE-agentのパスを設定
        self.swe_agent_path = config.custom_settings.get(
            "swe_agent_path",
            Path.home() / "SWE-agent"
        )

    def _validate_config(self) -> None:
        if not self.config.api_key:
            raise ValueError("API_KEY is required for SWE-agent")

        if not self.config.model:
            self.config.model = "gpt-4-turbo"

        # Check if SWE-agent is installed
        if not Path(self.swe_agent_path).exists():
            raise ValueError(
                f"SWE-agent not found at {self.swe_agent_path}. "
                "Clone from https://github.com/princeton-nlp/SWE-agent"
            )

    def process_task(
        self, task: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        try:
            # Prepare SWE-agent configuration
            config_data = {
                "task": task,
                "model": self.config.model,
                "repo_path": context.get("repo_path", ".") if context else ".",
                "api_key": self.config.api_key,
            }

            # Run SWE-agent
            result = self._run_swe_agent(config_data)

            return AgentResponse(
                success=result["success"],
                message=result["message"],
                changes=result.get("changes", []),
                metadata={"model": self.config.model, "context": context or {}},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to process task",
                error=str(e),
            )

    def fix_ci_errors(
        self, error_logs: dict[str, str], branch: str
    ) -> AgentResponse:
        try:
            # Format errors for SWE-agent
            error_summary = "\n\n".join(
                f"=== {error_type} ===\n{log}"
                for error_type, log in error_logs.items()
            )

            task = f"""Fix the following CI errors:

{error_summary}

Branch: {branch}

Steps:
1. Analyze the errors
2. Locate the problematic code
3. Implement fixes
4. Verify the fixes
"""

            config_data = {
                "task": task,
                "model": self.config.model,
                "repo_path": ".",
                "api_key": self.config.api_key,
            }

            result = self._run_swe_agent(config_data)

            return AgentResponse(
                success=result["success"],
                message=result["message"],
                changes=result.get("changes", []),
                metadata={"branch": branch, "error_types": list(error_logs.keys())},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to fix CI errors",
                error=str(e),
            )

    def review_code(
        self, diff: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        try:
            task = f"""Review this code change:

```diff
{diff}
```

Provide:
1. Code quality analysis
2. Potential issues
3. Improvement suggestions
"""

            config_data = {
                "task": task,
                "model": self.config.model,
                "repo_path": context.get("repo_path", ".") if context else ".",
                "api_key": self.config.api_key,
            }

            result = self._run_swe_agent(config_data)

            return AgentResponse(
                success=result["success"],
                message=result["message"],
                changes=["Code review completed"],
                metadata={"diff_size": len(diff), "context": context or {}},
            )
        except Exception as e:
            return AgentResponse(
                success=False,
                message="Failed to review code",
                error=str(e),
            )

    def _run_swe_agent(self, config: dict[str, Any]) -> dict[str, Any]:
        """Run SWE-agent with given configuration."""
        try:
            # Write config to temporary file
            import tempfile
            with tempfile.NamedTemporaryFile(
                mode='w', suffix='.json', delete=False
            ) as f:
                json.dump(config, f)
                config_file = f.name

            # Run SWE-agent
            cmd = [
                "python",
                str(self.swe_agent_path / "run.py"),
                "--config", config_file,
                "--model", config["model"],
                "--repo_path", config["repo_path"],
            ]

            result = subprocess.run(
                cmd,
                capture_output=True,
                text=True,
                timeout=300,  # 5 minutes timeout
            )

            # Parse result
            if result.returncode == 0:
                return {
                    "success": True,
                    "message": result.stdout,
                    "changes": self._parse_changes(result.stdout),
                }
            else:
                return {
                    "success": False,
                    "message": f"SWE-agent failed: {result.stderr}",
                    "changes": [],
                }
        except subprocess.TimeoutExpired:
            return {
                "success": False,
                "message": "SWE-agent timed out",
                "changes": [],
            }
        except Exception as e:
            return {
                "success": False,
                "message": f"Error running SWE-agent: {str(e)}",
                "changes": [],
            }
        finally:
            # Clean up config file
            try:
                Path(config_file).unlink()
            except:
                pass

    def _parse_changes(self, output: str) -> list[str]:
        """Parse changes from SWE-agent output."""
        changes = []
        # Parse SWE-agent output format
        # This depends on SWE-agent's output format
        for line in output.split('\n'):
            if 'Modified:' in line or 'Created:' in line:
                changes.append(line.strip())
        return changes

    def get_capabilities(self) -> dict[str, bool]:
        """Get SWE-agent specific capabilities."""
        return {
            **super().get_capabilities(),
            "autonomous_debugging": True,
            "repository_navigation": True,
            "test_execution": True,
            "multi_step_reasoning": True,
            "open_source": True,
        }
```

#### 4.4 エージェント設定

`.agent-config.yml`:

```yaml
agent:
  type: swe_agent
  model: gpt-4-turbo
  max_tokens: 4096
  temperature: 0.7

swe_agent:
  swe_agent_path: "/path/to/SWE-agent"
  backend: "openai"  # or "anthropic"
  autonomous_mode: true
  max_iterations: 30
```

#### 4.5 使用方法

**Docker使用:**

```bash
docker run -it \
  -e OPENAI_API_KEY=$OPENAI_API_KEY \
  -v $(pwd):/workspace \
  sweagent/swe-agent:latest \
  --task "Fix the division by zero error in calculator.py"
```

**Python API:**

```python
from src.agent_abstraction import AgentFactory, AgentType

agent = AgentFactory.create_agent(
    agent_type=AgentType.SWE_AGENT,
    api_key="your-api-key",
    model="gpt-4-turbo",
    swe_agent_path="/path/to/SWE-agent"
)

response = agent.fix_ci_errors(
    error_logs={"pytest": "test_calculator.py::test_divide FAILED"},
    branch="main"
)

print(response.message)
```

---

## 5. カスタムエージェントの追加

独自のコーディングエージェントを追加することもできます。

### 5.1 新しいエージェントクラスの作成

`src/agent_abstraction/my_agent.py`:

```python
"""Custom agent implementation."""

from typing import Any, Optional

from .base_agent import AgentConfig, AgentResponse, AgentType, BaseAgent


class MyCustomAgent(BaseAgent):
    """Custom coding agent implementation."""

    def _validate_config(self) -> None:
        if not self.config.api_key:
            raise ValueError("API_KEY is required")

        if not self.config.model:
            self.config.model = "default-model"

    def process_task(
        self, task: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        # Implement your logic here
        return AgentResponse(
            success=True,
            message="Task processed",
            changes=["Custom implementation"],
        )

    def fix_ci_errors(
        self, error_logs: dict[str, str], branch: str
    ) -> AgentResponse:
        # Implement CI fix logic
        pass

    def review_code(
        self, diff: str, context: Optional[dict[str, Any]] = None
    ) -> AgentResponse:
        # Implement code review logic
        pass
```

### 5.2 エージェントタイプの追加

`src/agent_abstraction/base_agent.py`:

```python
class AgentType(Enum):
    # ... existing types ...
    MY_CUSTOM = "my_custom"
```

### 5.3 ファクトリーに登録

```python
from src.agent_abstraction import AgentFactory, AgentType
from src.agent_abstraction.my_agent import MyCustomAgent

# Register custom agent
AgentFactory.register_agent(AgentType.MY_CUSTOM, MyCustomAgent)

# Use it
agent = AgentFactory.create_agent(
    agent_type=AgentType.MY_CUSTOM,
    api_key="your-key"
)
```

---

## まとめ

各エージェントの選択基準:

| エージェント | 推奨ケース | 強み | 注意点 |
|------------|----------|------|-------|
| **Claude Code** | 研究開発、TDD | GitHub統合、高品質 | APIコスト |
| **Gemini** | 大規模コード | 長コンテキスト、高速 | 新しいモデル |
| **Copilot** | 日常開発 | GitHub統合 | 要サブスクリプション |
| **SWE-agent** | バグ修正 | 自律性、オープンソース | セットアップ複雑 |

詳細は各エージェントの公式ドキュメントも参照してください。
